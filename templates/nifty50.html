{% extends "base.html" %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title mb-3">NIFTY50 Stocks - Latest Prices</h5>
          <p class="text-muted mb-3">All NIFTY50 stocks with their latest prices (search to filter by first letter)</p>
          
          <div class="mb-3">
            <input id="niftySearchInput" type="text" class="form-control" placeholder="Filter NIFTY50 stocks (e.g., REL, ABB, TCS)..." autocomplete="off">
          </div>

          <!-- NIFTY Loading Spinner -->
          <div id="niftyLoadingSpinner" class="text-center" style="display: none;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Fetching prices...</p>
          </div>

          <!-- NIFTY Stocks Table -->
          <div id="niftyStocksContainer" style="display: none;">
            <div class="table-responsive">
              <table class="table table-striped table-hover" style="margin-bottom: 0;">
                <thead style="background-color: #f8f9fa;">
                  <tr>
                    <th>Symbol</th>
                    <th>Latest Price (₹)</th>
                    <th>200-Week Avg (₹)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="niftyStocksTable">
                </tbody>
              </table>
            </div>
          </div>

          <!-- NIFTY No Results -->
          <div id="niftyNoResults" style="display: none; text-align: center; padding: 20px;">
            <p class="text-muted">No stocks found matching your search.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // NIFTY Stocks functionality
    const niftySearchInput = document.getElementById('niftySearchInput');
    const niftyLoadingSpinner = document.getElementById('niftyLoadingSpinner');
    const niftyStocksContainer = document.getElementById('niftyStocksContainer');
    const niftyStocksTable = document.getElementById('niftyStocksTable');
    const niftyNoResults = document.getElementById('niftyNoResults');
    let niftySearchTimeout;
    let allNiftyStocks = []; // Cache all stocks

    // Function to display NIFTY stocks
    async function loadNiftyStocks(searchQuery = '') {
      niftyLoadingSpinner.style.display = 'block';
      niftyStocksContainer.style.display = 'none';
      niftyNoResults.style.display = 'none';

      try {
        const response = await fetch(`/api/nifty-stocks?q=${encodeURIComponent(searchQuery)}`);

        if (!response.ok) {
          console.error('NIFTY search failed:', response.statusText);
          niftyLoadingSpinner.style.display = 'none';
          niftyNoResults.style.display = 'block';
          niftyStocksContainer.style.display = 'none';
          return;
        }

        const data = await response.json();
        const stocks = data.stocks || [];

        // Cache all stocks on first load
        if (searchQuery === '') {
          allNiftyStocks = stocks;
        }

        niftyLoadingSpinner.style.display = 'none';

        if (stocks.length === 0) {
          niftyNoResults.style.display = 'block';
          niftyStocksContainer.style.display = 'none';
          return;
        }

        // Populate table
        niftyStocksTable.innerHTML = stocks.map(stock => {
          const priceText = stock.price ? `₹${stock.price.toFixed(2)}` : 'N/A';
          const hasAvg = (stock.avg_200w && !isNaN(stock.avg_200w));
          const avgRaw = hasAvg ? parseFloat(stock.avg_200w) : null;
          const avgText = hasAvg ? `₹${avgRaw.toFixed(2)}` : '—';
          let statusBadge = '';
          let rowStyle = '';
          let avgStyle = 'color: #000;';

          if (stock.status === 'success') {
            statusBadge = '<span class="badge bg-success">✓ Fetched</span>';
          } else if (stock.status === 'no_data') {
            statusBadge = '<span class="badge bg-warning">No Data</span>';
          } else {
            statusBadge = '<span class="badge bg-danger">Error</span>';
          }

          // Highlight row green if price < 200-week avg
          if (stock.price && hasAvg) {
            try {
              if (parseFloat(stock.price) < avgRaw) {
                rowStyle = 'background-color: #d1e7dd;';
                avgStyle = 'color: #198754; font-weight: 600;';
              }
            } catch (e) {
              // ignore
            }
          }

          return `
            <tr class="${rowStyle ? 'highlight-row' : ''}">
              <td><strong>${stock.symbol}</strong></td>
              <td>${priceText}</td>
              <td style="${avgStyle}">${avgText}</td>
              <td>${statusBadge}</td>
            </tr>
          `;
        }).join('');

        niftyStocksContainer.style.display = 'block';
        niftyNoResults.style.display = 'none';
      } catch (error) {
        console.error('NIFTY search error:', error);
        niftyLoadingSpinner.style.display = 'none';
        niftyNoResults.style.display = 'block';
        niftyStocksContainer.style.display = 'none';
      }
    }

    // Load all NIFTY stocks on page load
    loadNiftyStocks();

    // Search functionality
    niftySearchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim().toUpperCase();

      clearTimeout(niftySearchTimeout);

      niftySearchTimeout = setTimeout(() => {
        if (query === '') {
          // Show all stocks if search is empty
          loadNiftyStocks();
        } else {
          // Filter from cached stocks
          const filtered = allNiftyStocks.filter(stock => 
            stock.symbol.startsWith(query)
          );

          niftyLoadingSpinner.style.display = 'none';

          if (filtered.length === 0) {
            niftyNoResults.style.display = 'block';
            niftyStocksContainer.style.display = 'none';
            return;
          }

          // Populate table with filtered results
          niftyStocksTable.innerHTML = filtered.map(stock => {
            const priceText = stock.price ? `₹${stock.price.toFixed(2)}` : 'N/A';
            const hasAvg = (stock.avg_200w && !isNaN(stock.avg_200w));
            const avgRaw = hasAvg ? parseFloat(stock.avg_200w) : null;
            const avgText = hasAvg ? `₹${avgRaw.toFixed(2)}` : '—';
            let statusBadge = '';
            let rowStyle = '';
            let avgStyle = 'color: #000;';

            if (stock.status === 'success') {
              statusBadge = '<span class="badge bg-success">✓ Fetched</span>';
            } else if (stock.status === 'no_data') {
              statusBadge = '<span class="badge bg-warning">No Data</span>';
            } else {
              statusBadge = '<span class="badge bg-danger">Error</span>';
            }

            // Highlight row green if price < 200-week avg
            if (stock.price && hasAvg) {
              try {
                if (parseFloat(stock.price) < avgRaw) {
                  rowStyle = 'background-color: #d1e7dd;';
                  avgStyle = 'color: #198754; font-weight: 600;';
                }
              } catch (e) {
                // ignore
              }
            }

            return `
              <tr class="${rowStyle ? 'highlight-row' : ''}">
                <td><strong>${stock.symbol}</strong></td>
                <td>${priceText}</td>
                <td style="${avgStyle}">${avgText}</td>
                <td>${statusBadge}</td>
              </tr>
            `;
          }).join('');

          niftyStocksContainer.style.display = 'block';
          niftyNoResults.style.display = 'none';
        }
      }, 300);
    });
  </script>
{% endblock %}
