{% extends "base.html" %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title mb-3">NIFTY Next 50 Stocks - Latest Prices</h5>
          <p class="text-muted mb-3">All NIFTY Next 50 stocks with their latest prices (search to filter by first letter)</p>
          
          <div class="mb-3">
            <input id="niftyNext50SearchInput" type="text" class="form-control" placeholder="Filter NIFTY Next 50 stocks (e.g., ABB, DLF, VEDL)..." autocomplete="off">
          </div>

          <!-- NIFTY Next 50 Loading Spinner -->
          <div id="niftyNext50LoadingSpinner" class="text-center" style="display: none;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Fetching prices...</p>
          </div>

          <!-- NIFTY Next 50 Stocks Table -->
          <div id="niftyNext50StocksContainer" style="display: none;">
            <div class="table-responsive">
              <table class="table table-striped table-hover" style="margin-bottom: 0;">
                <thead style="background-color: #f8f9fa;">
                  <tr>
                    <th>Symbol</th>
                    <th>Latest Price (₹)</th>
                    <th>200-Week Avg (₹)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="niftyNext50StocksTable">
                </tbody>
              </table>
            </div>
          </div>

          <!-- NIFTY Next 50 No Results -->
          <div id="niftyNext50NoResults" style="display: none; text-align: center; padding: 20px;">
            <p class="text-muted">No stocks found matching your search.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // NIFTY Next 50 Stocks functionality
    const niftyNext50SearchInput = document.getElementById('niftyNext50SearchInput');
    const niftyNext50LoadingSpinner = document.getElementById('niftyNext50LoadingSpinner');
    const niftyNext50StocksContainer = document.getElementById('niftyNext50StocksContainer');
    const niftyNext50StocksTable = document.getElementById('niftyNext50StocksTable');
    const niftyNext50NoResults = document.getElementById('niftyNext50NoResults');
    let niftyNext50SearchTimeout;
    let allNiftyNext50Stocks = []; // Cache all stocks

    // Function to display NIFTY Next 50 stocks
    async function loadNiftyNext50Stocks(searchQuery = '') {
      niftyNext50LoadingSpinner.style.display = 'block';
      niftyNext50StocksContainer.style.display = 'none';
      niftyNext50NoResults.style.display = 'none';

      try {
        const response = await fetch(`/api/nifty-next-50-stocks?q=${encodeURIComponent(searchQuery)}`);

        if (!response.ok) {
          console.error('NIFTY Next 50 search failed:', response.statusText);
          niftyNext50LoadingSpinner.style.display = 'none';
          niftyNext50NoResults.style.display = 'block';
          niftyNext50StocksContainer.style.display = 'none';
          return;
        }

        const data = await response.json();
        const stocks = data.stocks || [];

        // Cache all stocks on first load
        if (searchQuery === '') {
          allNiftyNext50Stocks = stocks;
        }

        niftyNext50LoadingSpinner.style.display = 'none';

        if (stocks.length === 0) {
          niftyNext50NoResults.style.display = 'block';
          niftyNext50StocksContainer.style.display = 'none';
          return;
        }

        // Populate table
        niftyNext50StocksTable.innerHTML = stocks.map(stock => {
          const priceText = stock.price ? `₹${stock.price.toFixed(2)}` : 'N/A';
          const hasAvg = (stock.avg_200w && !isNaN(stock.avg_200w));
          const avgRaw = hasAvg ? parseFloat(stock.avg_200w) : null;
          const avgText = hasAvg ? `₹${avgRaw.toFixed(2)}` : '—';
          let statusBadge = '';
          let rowStyle = '';
          let avgStyle = 'color: #000;';

          if (stock.status === 'success') {
            statusBadge = '<span class="badge bg-success">✓ Fetched</span>';
          } else if (stock.status === 'no_data') {
            statusBadge = '<span class="badge bg-warning">No Data</span>';
          } else {
            statusBadge = '<span class="badge bg-danger">Error</span>';
          }

          // Highlight row green if price < 200-week avg
          if (stock.price && hasAvg) {
            try {
              if (parseFloat(stock.price) < avgRaw) {
                rowStyle = 'background-color: #d1e7dd;';
                avgStyle = 'color: #198754; font-weight: 600;';
              }
            } catch (e) {
              // ignore
            }
          }

          return `
            <tr class="${rowStyle ? 'highlight-row' : ''}">
              <td><strong>${stock.symbol}</strong></td>
              <td>${priceText}</td>
              <td style="${avgStyle}">${avgText}</td>
              <td>${statusBadge}</td>
            </tr>
          `;
        }).join('');

        niftyNext50StocksContainer.style.display = 'block';
        niftyNext50NoResults.style.display = 'none';
      } catch (error) {
        console.error('NIFTY Next 50 search error:', error);
        niftyNext50LoadingSpinner.style.display = 'none';
        niftyNext50NoResults.style.display = 'block';
        niftyNext50StocksContainer.style.display = 'none';
      }
    }

    // Load all NIFTY Next 50 stocks on page load
    loadNiftyNext50Stocks();

    // Search functionality
    niftyNext50SearchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim().toUpperCase();

      clearTimeout(niftyNext50SearchTimeout);

      niftyNext50SearchTimeout = setTimeout(() => {
        if (query === '') {
          // Show all stocks if search is empty
          loadNiftyNext50Stocks();
        } else {
          // Filter from cached stocks
          const filtered = allNiftyNext50Stocks.filter(stock => 
            stock.symbol.startsWith(query)
          );

          niftyNext50LoadingSpinner.style.display = 'none';

          if (filtered.length === 0) {
            niftyNext50NoResults.style.display = 'block';
            niftyNext50StocksContainer.style.display = 'none';
            return;
          }

          // Populate table with filtered results
          niftyNext50StocksTable.innerHTML = filtered.map(stock => {
            const priceText = stock.price ? `₹${stock.price.toFixed(2)}` : 'N/A';
            const hasAvg = (stock.avg_200w && !isNaN(stock.avg_200w));
            const avgRaw = hasAvg ? parseFloat(stock.avg_200w) : null;
            const avgText = hasAvg ? `₹${avgRaw.toFixed(2)}` : '—';
            let statusBadge = '';
            let rowStyle = '';
            let avgStyle = 'color: #000;';

            if (stock.status === 'success') {
              statusBadge = '<span class="badge bg-success">✓ Fetched</span>';
            } else if (stock.status === 'no_data') {
              statusBadge = '<span class="badge bg-warning">No Data</span>';
            } else {
              statusBadge = '<span class="badge bg-danger">Error</span>';
            }

            // Highlight row green if price < 200-week avg
            if (stock.price && hasAvg) {
              try {
                if (parseFloat(stock.price) < avgRaw) {
                  rowStyle = 'background-color: #d1e7dd;';
                  avgStyle = 'color: #198754; font-weight: 600;';
                }
              } catch (e) {
                // ignore
              }
            }

            return `
              <tr class="${rowStyle ? 'highlight-row' : ''}">
                <td><strong>${stock.symbol}</strong></td>
                <td>${priceText}</td>
                <td style="${avgStyle}">${avgText}</td>
                <td>${statusBadge}</td>
              </tr>
            `;
          }).join('');

          niftyNext50StocksContainer.style.display = 'block';
          niftyNext50NoResults.style.display = 'none';
        }
      }, 300);
    });
  </script>
{% endblock %}
